# Dev VM — Ubuntu 24.04 LTS with Docker, k3s, Helm, Java 21, Node.js, and CLI Tools

Fully automated, one-command setup for a **headless Ubuntu 24.04 LTS development VM** inside VirtualBox on **Windows or macOS**. The VM comes pre-installed with **Docker, k3s (lightweight Kubernetes), Helm, Java 21, Node.js LTS, k9s, kubectx/kubens, yq, and lazydocker**. Kubeconfig is automatically exported to the host.

---

## Project Structure

```
dev-vm/
  scripts/
    setup-dev-vm.ps1      # Main setup & management script
    cleanup-install.ps1    # Cleanup script (called by setup-dev-vm.ps1)
  vagrant/
    defaults.yaml          # Default VM settings and port forwards (committed)
    env.yaml               # Your personal overrides (gitignored)
    Vagrantfile            # Generated by setup script (gitignored)
    .vagrant/              # Vagrant state (gitignored)
    setup-dev-vm.log       # Session log (gitignored)
  README.md
```

The shared workspace folder is created at `~/workspace` (your home directory) and synced into the VM at `/home/vagrant/workspace`.

---

## Features

- **Interactive menu** — Setup, Cleanup, Health Check, Update, or Re-provision from a single entry point
- **Fully parameterised** — pass all options as flags for CI/scripted use (`-SkipConfirm`)
- **Cross-platform** — works on Windows (winget) and macOS (Homebrew)
- **Auto-installs host tools** — VirtualBox, Vagrant, Helm, and Docker CLI via winget or brew
- **Version pinning** — lock k3s and Node.js to specific versions (`-K3sVersion`, `-NodeVersion`)
- **Health check** — one-command VM + cluster health report
- **Software updates** — update all VM tools (system packages, k3s, CLI tools, npm)
- **Snapshot** — automatic baseline snapshot after provisioning for quick restore
- **SSH key injection** — host SSH public keys are automatically added to the VM
- **Docker Hub login** — optional auto-login with `-DockerHubUser` and `-DockerHubToken`
- **Checksum verification** — SHA256 verification for downloaded CLI tools
- **GitHub API auth** — uses your GitHub token for API calls to avoid rate limits
- **DryRun mode** — generate Vagrantfile without starting the VM (`-DryRun`)
- **Retry on failure** — offers to retry provisioning if `vagrant up` fails
- **Token masking** — GitHub and Docker Hub tokens are hidden during input
- **Input validation** — numeric ranges, IP format, re-prompt on bad input
- **Transcript logging** — full session log to `vagrant/setup-dev-vm.log`

### VM Tool Stack

| Tool | Description |
|------|-------------|
| Docker CE | Container engine with Compose and Buildx plugins |
| k3s | Lightweight Kubernetes (replaces KIND) |
| Helm | Kubernetes package manager |
| kubectl | Kubernetes CLI (ships with k3s) |
| Java 21 | OpenJDK headless |
| Node.js LTS | JavaScript runtime + npm |
| k9s | Kubernetes terminal UI |
| kubectx / kubens | Fast context & namespace switching |
| yq | YAML processor |
| lazydocker | Docker terminal UI |

---

## Prerequisites

### Windows
- Windows 10 or 11
- PowerShell 5.1+ (pre-installed)

### macOS
- macOS 12+ (Monterey or later)
- Homebrew (`/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"`)
- PowerShell Core (`brew install --cask powershell`)

### Both
- Internet connection

> VirtualBox and Vagrant are installed automatically if missing (via winget on Windows, Homebrew on macOS).

---

## Quick Start

### Windows

```powershell
git clone <repo-url>
cd <repo-directory>
.\scripts\setup-dev-vm.ps1
```

### macOS

```bash
git clone <repo-url>
cd <repo-directory>
pwsh ./scripts/setup-dev-vm.ps1
```

The interactive menu will appear:

```
  1) Setup new Dev VM
  2) Clean up / destroy Dev VM
  3) Health check
  4) Update VM software
  5) Re-provision VM
  6) Repair VM (diagnose & fix)
```

Select **1** and follow the prompts for GitHub token, Docker Hub token, CPU count, and memory.

### Non-Interactive / CI Mode

```powershell
.\scripts\setup-dev-vm.ps1 -Action Setup -CPUs 4 -Memory 8192 -DiskGB 50 -SkipConfirm
```

All parameters are optional — unset values prompt interactively.

---

## Configuration Files

Settings are driven by two YAML files in the `vagrant/` directory:

| File | Purpose | Committed? |
|------|---------|------------|
| `vagrant/defaults.yaml` | Default VM settings and port forwards | Yes |
| `vagrant/env.yaml` | Your personal overrides | No (gitignored) |

### Precedence

```
CLI params (-CPUs 8)  >  env.yaml  >  defaults.yaml  >  interactive prompt
```

### Customizing Ports

Create `vagrant/env.yaml` to override any section. If you specify `ports`, it **replaces** the entire default list:

```yaml
# vagrant/env.yaml — override just what you need
vm:
  cpus: 8
  memory: 16384

ports:
  - guest: 6443
    host: 6443
    description: k3s API
  - guest: 8080
    host: 8080
  - guest: 3000
    host: 3000
  - guest: 5432
    host: 5432
    description: PostgreSQL
  - guest: 443
    host: 8443
    description: Ingress HTTPS
```

Scalar values under `vm:` are merged per-key (only override what you specify). The `ports` list is replaced entirely if present.

### Storing Credentials

Add a `credentials:` section to `vagrant/env.yaml` to avoid re-entering tokens on every run. The file is gitignored, so your tokens stay local:

```yaml
# vagrant/env.yaml
credentials:
  github_token: ghp_xxxxxxxxxxxxxxxxxxxx
  dockerhub_user: myuser
  dockerhub_token: dckr_pat_xxxxxxxxxxxx
```

If you enter credentials interactively during setup, the script will offer to save them to `env.yaml` automatically. CLI parameters (`-GitHubToken`, `-DockerHubToken`, `-DockerHubUser`) always take highest precedence.

---

## After Setup

### SSH into the VM

```powershell
cd vagrant
vagrant ssh
```

### Verify the tool stack

```bash
docker version
kubectl get nodes
k9s
java -version
node -v
helm version --short
```

### Access Kubernetes & Docker from the Host

Helm, kubectl, and Docker CLI are installed on the host automatically. The kubeconfig is copied to `~/.kube/config-dev-vm` and the Docker daemon listens on TCP port 2375 over the private network.

```powershell
# PowerShell (Windows or macOS)
$env:KUBECONFIG = "$HOME/.kube/config-dev-vm"
$env:DOCKER_HOST = "tcp://192.168.56.10:2375"
kubectl get nodes
helm install my-release my-chart
docker ps
```

```bash
# Bash/Zsh (macOS)
export KUBECONFIG="$HOME/.kube/config-dev-vm"
export DOCKER_HOST="tcp://192.168.56.10:2375"
kubectl get nodes
helm install my-release my-chart
docker ps
```

### Restore from Snapshot

A `fresh-install` snapshot is automatically created after a successful setup. To restore:

```powershell
cd vagrant
vagrant snapshot restore fresh-install
```

---

## Health Check

Check the status of the VM, services, and Kubernetes cluster:

```powershell
.\scripts\setup-dev-vm.ps1 -Action Health
```

This reports:
- VM status and service health (Docker, k3s)
- Kubernetes node status
- Disk and memory usage
- Installed tool versions

---

## Repair

Diagnose and auto-fix common VM issues:

```powershell
.\scripts\setup-dev-vm.ps1 -Action Repair
```

Or select option **6** from the interactive menu. The repair engine:
- Starts the VM if stopped or suspended
- Restarts Docker or k3s if not active
- Waits for the Kubernetes node to become Ready
- Re-extracts the host kubeconfig if missing or broken
- Reinstalls missing CLI tools (k9s, yq, lazydocker, kubectx, kubens)
- Cleans disk space if usage exceeds 90% (prunes Docker images/cache, apt cache, journal logs)

Repair also runs automatically after initial setup and after provisioning retries, ensuring the `fresh-install` snapshot captures a verified-healthy state.

---

## Update VM Software

Update all software inside the VM to their latest versions:

```powershell
.\scripts\setup-dev-vm.ps1 -Action Update
```

This updates:
- System packages (`apt upgrade`)
- k3s (checks stable channel, updates if newer)
- CLI tools (k9s, yq, lazydocker, kubectx, kubens — via GitHub API)
- npm (global update)
- Re-exports kubeconfig after k3s update

---

## Re-provision

Re-run all provisioning stages without destroying the VM:

```powershell
.\scripts\setup-dev-vm.ps1 -Action Provision
```

---

## Cleanup

Run the script again and choose option **2**, or:

```powershell
.\scripts\setup-dev-vm.ps1 -Action Cleanup
```

This will:
1. Delete VM snapshots (with confirmation)
2. Destroy the Vagrant VM
3. Remove generated files (Vagrantfile, .vagrant/, log)
4. Remove the `~/workspace` folder (with confirmation)
5. Remove the host-side kubeconfig
6. Optionally uninstall Vagrant and VirtualBox via winget/brew

Use `-SkipConfirm` to skip all prompts.

---

## Parameters

| Parameter | Description | Default |
|-----------|-------------|---------|
| `-Action` | Skip menu: `Setup`, `Cleanup`, `Health`, `Update`, `Provision`, `Repair` | (interactive) |
| `-VMName` | VM name | `dev-vm` |
| `-CPUs` | vCPU count (1-32) | `4` |
| `-Memory` | RAM in MB (1024-65536) | `8192` |
| `-DiskGB` | Root disk in GB (10-500) | `80` |
| `-PrivateIP` | Host-only network IP | `192.168.56.10` |
| `-GitHubToken` | GitHub PAT (injected into VM, used for API calls) | (optional) |
| `-DockerHubToken` | Docker Hub token | (optional) |
| `-DockerHubUser` | Docker Hub username (enables `docker login`) | (optional) |
| `-K3sVersion` | Pin k3s version (e.g. `v1.31.4+k3s1`) | latest |
| `-NodeVersion` | Pin Node.js major version (e.g. `22`) | `lts` |
| `-DryRun` | Generate Vagrantfile and exit | `$false` |
| `-SkipConfirm` | Skip all confirmation prompts | `$false` |

### Default Port Forwards

Configured in `vagrant/defaults.yaml`. Override with `vagrant/env.yaml`.

| Guest | Host | Purpose |
|-------|------|---------|
| 6443 | 6443 | k3s API |
| 2375 | — | Docker API (via private network IP, always on) |
| 8080 | 8080 | App server |
| 3000 | 3000 | Dev server |
| 30000 | 30000 | NodePort |
| 443 | 8443 | Ingress HTTPS |

---

## Troubleshooting

**VM fails to boot** — Ensure Hyper-V is disabled (`bcdedit /set hypervisorlaunchtype off` then reboot). VirtualBox requires hardware virtualization.

**SSH timeout during setup** — The script will offer to retry provisioning. The VM boot timeout is set to 600 seconds. You can also run `.\scripts\setup-dev-vm.ps1 -Action Provision` to re-provision.

**Docker permission denied** — Reload the VM (`cd vagrant && vagrant reload && vagrant ssh`) to apply group membership.

**kubectl fails on host** — Verify `KUBECONFIG` points to `~/.kube/config-dev-vm`.

**GitHub API rate limit** — Provide a `-GitHubToken` to increase API limits (used for CLI tool downloads).

**Vagrant not found after install** — Reboot to refresh PATH, then re-run the script.
